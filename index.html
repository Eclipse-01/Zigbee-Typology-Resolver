<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZigBee æ‹“æ‰‘æ™ºèƒ½åˆ†æå™¨ Pro</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ•¸ï¸</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/vis-network.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-hover: #4338ca; /* Indigo 700 */
            --bg-main: #f8fafc; /* Slate 50 */
            --bg-panel: #ffffff;
            --text-main: #1e293b; /* Slate 800 */
            --text-sub: #64748b; /* Slate 500 */
            --border: #e2e8f0; /* Slate 200 */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-main); color: var(--text-main); overflow: hidden; }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* Header Styling */
        header { 
            background: white; 
            padding: 0.75rem 1.5rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 20;
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        .brand h1 { margin: 0; font-size: 1.1rem; font-weight: 700; color: #0f172a; letter-spacing: -0.025em; }
        .badge { background-color: #eff6ff; color: var(--primary); padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; border: 1px solid #dbeafe; }
        .status-dot { height: 8px; width: 8px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 6px; }
        
        /* Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar Styling */
        .sidebar { 
            width: 380px; 
            background: var(--bg-panel); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            z-index: 10; 
            box-shadow: 4px 0 24px rgba(0,0,0,0.02);
        }
        
        .panel-section { padding: 1.25rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .panel-title { font-size: 0.85rem; font-weight: 600; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
        .panel-desc { font-size: 0.75rem; color: var(--text-sub); margin-top: -0.5rem; line-height: 1.4; }

        /* Textarea Styling */
        .input-wrapper { flex: 1; padding: 0 1.25rem; display: flex; flex-direction: column; min-height: 0; }
        textarea { 
            flex: 1; 
            width: 100%; 
            box-sizing: border-box; 
            padding: 1rem; 
            border: 1px solid var(--border); 
            border-radius: 0.75rem; 
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace; 
            font-size: 0.8rem; 
            line-height: 1.5;
            resize: none; 
            outline: none; 
            background-color: #f8fafc;
            color: #334155;
            transition: all 0.2s;
        }
        textarea:focus { border-color: var(--primary); background-color: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        textarea::placeholder { color: #94a3b8; }

        /* Button Styling */
        .action-area { padding: 1.25rem; border-top: 1px solid var(--border); background-color: white; }
        button { 
            width: 100%; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%); 
            color: white; 
            border: none; 
            padding: 0.85rem 1rem; 
            border-radius: 0.75rem; 
            font-weight: 600; 
            font-size: 0.9rem;
            cursor: pointer; 
            transition: all 0.2s ease; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px; 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        button:active { transform: translateY(0); }
        button:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Canvas Area */
        .canvas-area { flex: 1; position: relative; background-color: #f1f5f9; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        #network-container { width: 100%; height: 100%; }

        /* Floating Components */
        .legend { 
            position: absolute; 
            top: 1.5rem; 
            right: 1.5rem; 
            background: rgba(255, 255, 255, 0.85); 
            padding: 1rem; 
            border-radius: 1rem; 
            box-shadow: var(--shadow); 
            border: 1px solid rgba(255,255,255,0.5); 
            font-size: 0.8rem; 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            min-width: 140px;
        }
        .legend-title { font-weight: 700; margin-bottom: 0.75rem; color: var(--text-main); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; color: var(--text-main); font-weight: 500; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Loading State */
        .loading-overlay { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(255,255,255,0.6); 
            backdrop-filter: blur(4px); 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            z-index: 50; 
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        .spinner { 
            border: 3px solid #e2e8f0; 
            border-top: 3px solid var(--primary); 
            border-radius: 50%; 
            width: 40px; height: 40px; 
            animation: spin 0.8s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite; 
            margin-bottom: 1rem; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #error-banner { 
            background-color: #fee2e2; color: #991b1b; 
            padding: 0.5rem; text-align: center; font-size: 0.8rem; font-weight: 600; display: none; 
        }
    </style>
</head>
<body>
<div class="app-container">
    <div id="error-banner">âš ï¸ Vis.js åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚</div>
    
    <header>
        <div class="brand">
            <span style="font-size: 1.5rem;">ğŸ•¸ï¸</span>
            <div>
                <h1>ZigBee æ‹“æ‰‘åˆ†æå™¨</h1>
            </div>
            <span class="badge">Pro</span>
        </div>
        <div style="font-size: 0.8rem; color: var(--text-sub); display: flex; align-items: center;">
            <span class="status-dot"></span>
            <span id="status-text">ç³»ç»Ÿå°±ç»ª</span>
        </div>
    </header>

    <div class="main-content">
        <aside class="sidebar">
            <div class="panel-section">
                <div class="panel-title">åŸå§‹æ•°æ®è¾“å…¥</div>
                <div class="panel-desc">ç²˜è´´æ¥è‡ª SecureCRTã€XShell æˆ–åµŒå…¥å¼è°ƒè¯•å£çš„åŸå§‹ HEX/ASCII æ—¥å¿—ã€‚</div>
            </div>
            <div class="input-wrapper">
                <textarea id="serial-input" spellcheck="false" placeholder="[12:00:01] ROU NWK: 1234..."></textarea>
            </div>
            <div class="action-area">
                <button onclick="analyzeTopology()" id="generate-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h6"/><path d="M22 12h-6"/><path d="M12 2v2"/><path d="M12 12l4.09-4.09L18 6"/><path d="M12 12l-4.09 4.09L6 18"/><path d="M12 22v-2"/><path d="M12 12l-4.09-4.09L6 6"/><path d="M12 12l4.09 4.09L18 18"/></svg>
                    æ™ºèƒ½ç”Ÿæˆæ‹“æ‰‘ç»“æ„
                </button>
                <div style="text-align: center; font-size: 0.7rem; color: #94a3b8; margin-top: 10px;">
                    Powered by LLM Analysis
                </div>
            </div>
        </aside>

        <main class="canvas-area">
            <div id="network-container"></div>
            
            <div class="legend">
                <div class="legend-title">å›¾ä¾‹è¯´æ˜</div>
                <div class="legend-item"><span class="dot" style="background:#f97316;"></span> åè°ƒå™¨ (0000)</div>
                <div class="legend-item"><span class="dot" style="background:#22c55e;"></span> è·¯ç”±å™¨ (ROU)</div>
                <div class="legend-item"><span class="dot" style="background:#3b82f6;"></span> ç»ˆç«¯è®¾å¤‡ (END)</div>
            </div>

            <div id="loading-overlay" class="loading-overlay">
                <div class="spinner"></div>
                <div style="color: var(--text-main); font-weight: 600;">æ­£åœ¨è¿›è¡Œ AI è¯­ä¹‰åˆ†æ...</div>
                <div style="font-size: 0.8rem; color: var(--text-sub); margin-top: 5px;">è§£æèŠ‚ç‚¹å…³ç³»ä¸å±‚çº§ç»“æ„</div>
            </div>
        </main>
    </div>
</div>

<script>
    let network = null;
    let nodesDataSet = null;
    let edgesDataSet = null;

    // åˆå§‹åŒ– Vis.js æ•°æ®é›†
    window.addEventListener('load', function() {
        if (typeof vis === 'undefined') {
            document.getElementById('error-banner').style.display = 'block';
        } else {
            nodesDataSet = new vis.DataSet();
            edgesDataSet = new vis.DataSet();
            
            // å¡«å…¥é»˜è®¤ç¤ºä¾‹
            const exampleText = `[12:00:05] Get Data
ROU NWK: 6702 pNWK: 0000
[12:00:06] Get Data
END NWK: AB49 pNWK: 6702
[12:00:07] Hello World
ROU NWK: 5995 pNWK: 6702
END NWK: A98B pNWK: 5995`;
            document.getElementById('serial-input').value = exampleText;
        }
    });

    async function analyzeTopology() {
        const input = document.getElementById('serial-input').value.trim();
        const btn = document.getElementById('generate-btn');
        const loader = document.getElementById('loading-overlay');
        const status = document.getElementById('status-text');

        if (!input) { alert("è¯·å…ˆç²˜è´´ä¸²å£æ•°æ®ï¼"); return; }
        
        // UI çŠ¶æ€åˆ‡æ¢
        btn.disabled = true;
        loader.classList.add('active');
        status.innerText = "æ­£åœ¨è¯·æ±‚åç«¯...";
        status.style.color = "#f59e0b"; // Orange

        // ä¼˜åŒ–åçš„ Promptï¼šåŒ…å«æ˜ç¡®çš„è§„åˆ™å’Œç¤ºä¾‹ï¼Œé˜²æ­¢ AI äº§ç”Ÿå¹»è§‰
        const systemPrompt = `# Role
You are a ZigBee Network Log Parser. Your job is to extract network topology data from raw serial logs and output strictly valid JSON.

# Input Data Dictionary (CRITICAL RULES)
1. **Identify Device Type & ID**:
   - If line contains 'ROU NWK: <ID>', Node <ID> is a **Router** (Type: ROU).
   - If line contains 'END NWK: <ID>', Node <ID> is a **EndDevice** (Type: END).
   - If line contains 'Coordinator' or '0000', treat '0000' as the Root Coordinator (Type: COORD).

2. **Identify Relationships (Edges)**:
   - Look for the pattern 'pNWK: <ParentID>'.
   - This means <ParentID> is the PARENT of the current node.
   - Direction: From <ParentID> TO <CurrentID>.

3. **Constraint (STRICT MODE)**:
   - IGNORE ALL NON-TOPOLOGY lines.
   - **ABSOLUTELY NO GUESSING/ASSOCIATING:** If a node's parent is not explicitly defined in the log, or if the parent ID is a special value (FFFF, NULL, etc.), you MUST treat that node as a standalone node with NO edges.
   - Example: For 'END NWK: 9009 pNWK: FFFF', you must create Node 9009 and Edge {from: FFFF, to: 9009}.
   - Example: For 'END NWK: BBBB', you must create Node BBBB, but NO edge.
   - Output ONLY JSON, NO Markdown.

# Few-Shot Example
Input:
[12:00] ROU NWK: 1234 pNWK: 0000
[12:01] END NWK: 5678 pNWK: 1234

Output:
{
  "nodes": [
    { "id": "0000", "label": "COORD", "type": "COORD" },
    { "id": "1234", "label": "ROU 1234", "type": "ROU" },
    { "id": "5678", "label": "END 5678", "type": "END" }
  ],
  "edges": [
    { "from": "0000", "to": "1234" },
    { "from": "1234", "to": "5678" }
  ]
}`;

        try {
            // è°ƒç”¨ Vercel Serverless Function
            const response = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: input }
                    ]
                })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();
            // æ¸…æ´—æ•°æ®ï¼šå»é™¤å¯èƒ½å­˜åœ¨çš„ Markdown ä»£ç å—æ ‡è®°
            const content = data.choices[0].message.content;
            const jsonStr = content.replace(/```json/g, '').replace(/```/g, '').trim();
            
            const topologyData = JSON.parse(jsonStr);
            
            renderGraph(topologyData);
            
            status.innerText = "åˆ†æå®Œæˆ";
            status.style.color = "#22c55e"; // Green

        } catch (error) {
            console.error("Error:", error);
            alert("åˆ†æå¤±è´¥: " + error.message);
            status.innerText = "å‘ç”Ÿé”™è¯¯";
            status.style.color = "#ef4444"; // Red
        } finally {
            btn.disabled = false;
            loader.classList.remove('active');
        }
    }

    /**
     * æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šåŒ…å«è‡ªåŠ¨è¡¥å…¨å’Œåˆ†ç»„æ ·å¼é€»è¾‘
     */
    function renderGraph(data) {
        if (!nodesDataSet || !edgesDataSet) return;
        nodesDataSet.clear();
        edgesDataSet.clear();

        const nodeMap = new Map();
        
        // è¾…åŠ©ï¼šæ ‡å‡†åŒ– ID (è½¬å¤§å†™ï¼Œå» 0x)
        const clean = (id) => (id || "").replace(/^0x/i, '').toUpperCase();

        // 1. æ”¶é›†æ‰€æœ‰å‡ºç°çš„èŠ‚ç‚¹ ID (åŒ…æ‹¬ä»…åœ¨ edges ä¸­å‡ºç°çš„)
        const rawEdges = data.edges || [];
        const allNodeIds = new Set();
        
        rawEdges.forEach(edge => {
            allNodeIds.add(clean(edge.from));
            allNodeIds.add(clean(edge.to));
        });
        (data.nodes || []).forEach(node => allNodeIds.add(clean(node.id)));

        // 2. ç”ŸæˆèŠ‚ç‚¹æ•°æ® (å…³é”®ï¼šä½¿ç”¨ groups æ§åˆ¶æ ·å¼)
        allNodeIds.forEach(id => {
            // å°è¯•ä» AI è¿”å›çš„æ•°æ®ä¸­æ‰¾å®šä¹‰
            const aiNode = (data.nodes || []).find(n => clean(n.id) === id);
            
            // é»˜è®¤å€¼
            let group = "enddevice"; 
            let label = `DEV\n${id}`;

            // è§„åˆ™åˆ¤å®šé€»è¾‘
            if (id === "0000") {
                // å¼ºåˆ¶åˆ¤å®š 0000 ä¸ºåè°ƒå™¨
                group = "coordinator";
                label = `Coordinator\n0000`;
            } else if (aiNode) {
                // å¦‚æœ AI è¿”å›äº†ç±»å‹
                const type = (aiNode.type || "").toLowerCase();
                if (type.includes("rou")) group = "router";
                else if (type.includes("coord")) group = "coordinator";
                // ä½¿ç”¨ AI çš„ labelï¼Œæˆ–è€…è‡ªåŠ¨ç”Ÿæˆ
                label = aiNode.label || label;
            } else if (rawEdges.some(e => clean(e.from) === id)) {
                // å¦‚æœ AI æ²¡å®šä¹‰å®ƒï¼Œä½†å®ƒä½œä¸ºçˆ¶èŠ‚ç‚¹å‡ºç°äº†ï¼Œé‚£å®ƒè‚¯å®šæ˜¯è·¯ç”±å™¨
                group = "router";
                label = `ROU\n${id}`;
            }

            // å­˜å…¥ Map
            nodeMap.set(id, {
                id: id,
                label: label,
                group: group, // <--- æ ·å¼æ ¸å¿ƒ
                margin: 10
            });
        });

        // 3. ç”Ÿæˆè¿çº¿
        const edges = rawEdges.map(edge => ({
            from: clean(edge.from),
            to: clean(edge.to)
        }));

        // 4. è¿‡æ»¤å­¤ç«‹èŠ‚ç‚¹ï¼šåªä¿ç•™æœ‰è¿æ¥å…³ç³»çš„èŠ‚ç‚¹
        const connectedNodeIds = new Set();
        edges.forEach(edge => {
            connectedNodeIds.add(edge.from);
            connectedNodeIds.add(edge.to);
        });
        
        const connectedNodes = Array.from(nodeMap.values()).filter(node => 
            connectedNodeIds.has(node.id)
        );

        // 5. æ·»åŠ åˆ° Vis.js
        nodesDataSet.add(connectedNodes);
        edgesDataSet.add(edges);

        // 6. é…ç½®è§†å›¾
        if (!network) {
            const container = document.getElementById("network-container");
            const options = {
                // --- æ ·å¼ç»„é…ç½® (Groups) ---
                groups: {
                    coordinator: {
                        shape: 'hexagon',
                        color: { background: '#f97316', border: '#ea580c', highlight: '#fb923c' }, // Orange
                        font: { color: 'white', size: 14, face: 'Inter', bold: true },
                        borderWidth: 2,
                        size: 35
                    },
                    router: {
                        shape: 'ellipse',
                        color: { background: '#22c55e', border: '#16a34a', highlight: '#4ade80' }, // Green
                        font: { color: 'white', size: 12, face: 'Inter' },
                        borderWidth: 1
                    },
                    enddevice: {
                        shape: 'box',
                        color: { background: '#3b82f6', border: '#2563eb', highlight: '#60a5fa' }, // Blue
                        font: { color: 'white', size: 12, face: 'Inter' },
                        shapeProperties: { borderRadius: 6 },
                        borderWidth: 1
                    }
                },
                // --------------------------
                layout: { 
                    hierarchical: { 
                        direction: "UD", 
                        sortMethod: "directed", 
                        levelSeparation: 120, 
                        nodeSpacing: 180 
                    } 
                },
                edges: {
                    arrows: { to: { enabled: true, scaleFactor: 0.8 } },
                    color: { color: '#cbd5e1', highlight: '#3b82f6' },
                    width: 2,
                    smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.5 }
                },
                physics: { enabled: false },
                interaction: { hover: true, navigationButtons: true, zoomView: true }
            };
            network = new vis.Network(container, { nodes: nodesDataSet, edges: edgesDataSet }, options);
        } else {
            network.setData({ nodes: nodesDataSet, edges: edgesDataSet });
            network.fit();
        }
    }
</script>
</body>
</html>


