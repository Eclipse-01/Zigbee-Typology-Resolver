<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZigBee æ‹“æ‰‘æ™ºèƒ½åˆ†æå™¨ (Serverless)</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/vis-network.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f3f4f6;
            --border-color: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        header { background-color: var(--primary-color); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10; }
        header h1 { margin: 0; font-size: 1.25rem; }
        .badge { background-color: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 10px; border: 1px solid rgba(255,255,255,0.3); }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 350px; min-width: 300px; background: white; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 5; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .panel-header, .panel-footer { padding: 1rem; background-color: #f9fafb; border-bottom: 1px solid var(--border-color); }
        .panel-footer { border-top: 1px solid var(--border-color); border-bottom: none; }
        .panel-body { flex: 1; padding: 1rem; overflow: hidden; }
        textarea { width: 100%; height: 100%; box-sizing: border-box; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.875rem; resize: none; outline: none; }
        textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(37,99,235,0.2); }
        .canvas-area { flex: 1; position: relative; background-color: #f8fafc; }
        #network-container { width: 100%; height: 100%; }
        button { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        button:hover { background-color: var(--primary-hover); }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .input-group { margin-bottom: 0.75rem; position: relative; }
        .legend { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.95); padding: 0.75rem; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color); font-size: 0.75rem; backdrop-filter: blur(4px); }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(2px); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        #error-banner { background-color: #fee2e2; border-bottom: 1px solid #ef4444; color: #b91c1c; padding: 0.5rem; font-size: 0.875rem; text-align: center; display: none; }
    </style>
</head>
<body>
<div class="app-container">
    <div id="error-banner">âš ï¸ æ ¸å¿ƒåº“åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</div>
    <header>
        <div style="display:flex; align-items:center;">
            <span style="font-size: 1.5rem; margin-right: 8px;">ğŸ•¸ï¸</span>
            <div><h1>ZigBee æ‹“æ‰‘æ™ºèƒ½åˆ†æå™¨</h1></div>
            <span class="badge">Vercel ä»£ç†æ¨¡å¼</span>
        </div>
        <div style="font-size: 0.875rem; opacity: 0.9;">çŠ¶æ€: <span id="status-text">å‡†å¤‡å°±ç»ª</span></div>
    </header>
    <div class="main-content">
        <aside class="sidebar">
            <div class="panel-header">
                <label style="font-weight: bold; font-size: 0.875rem; display: block; margin-bottom: 4px;">ğŸ“ ä¸²å£åŸå§‹æ•°æ®</label>
                <div style="font-size: 0.75rem; color: var(--text-sub);">ç²˜è´´æ•°æ®ï¼Œç³»ç»Ÿå°†é€šè¿‡ Vercel åç«¯åˆ†æ</div>
            </div>
            <div class="panel-body">
                <textarea id="serial-input" placeholder="ç²˜è´´ä¸²å£è¾“å‡ºæ•°æ®..."></textarea>
            </div>
            <div class="panel-footer">
                <div style="font-size: 0.75rem; color: #666; margin-bottom: 10px; text-align: center;">
                    ä½¿ç”¨FlyAIç”Ÿæˆç»“æ„å›¾
                </div>
                <button onclick="analyzeTopology()" id="generate-btn">âœ¨ æ™ºèƒ½ç”Ÿæˆæ‹“æ‰‘å›¾</button>
            </div>
        </aside>
        <main class="canvas-area">
            <div id="network-container"></div>
            <div class="legend">
                <div style="font-weight: bold; margin-bottom: 6px; color: var(--text-main);">å›¾ä¾‹</div>
                <div class="legend-item"><span class="dot" style="background:#FF5722;"></span> åè°ƒå™¨</div>
                <div class="legend-item"><span class="dot" style="background:#4CAF50;"></span> è·¯ç”±å™¨</div>
                <div class="legend-item"><span class="dot" style="background:#2196F3;"></span> ç»ˆç«¯è®¾å¤‡</div>
            </div>
            <div id="loading-indicator" class="loading hidden">
                <div class="spinner"></div>
                <div style="color: var(--primary-color); font-weight: 600;">æ­£åœ¨è¿æ¥åç«¯åˆ†æ...</div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">è¯·æ±‚è·¯å¾„: /api/chat</div>
            </div>
        </main>
    </div>
</div>
<script>
    let network = null;
    let nodesDataSet = null;
    let edgesDataSet = null;

    window.addEventListener('load', function() {
        if (typeof vis === 'undefined') {
            document.getElementById('error-banner').style.display = 'block';
        } else {
            nodesDataSet = new vis.DataSet();
            edgesDataSet = new vis.DataSet();
        }
    });

    async function analyzeTopology() {
        const input = document.getElementById('serial-input').value.trim();
        const btn = document.getElementById('generate-btn');
        const loader = document.getElementById('loading-indicator');
        const status = document.getElementById('status-text');

        if (!input) { alert("è¯·å…ˆç²˜è´´ä¸²å£æ•°æ®ï¼"); return; }
        
        btn.disabled = true;
        btn.innerHTML = "åˆ†æä¸­...";
        loader.classList.remove('hidden');
        status.innerText = "è¯·æ±‚åç«¯...";

        const systemPrompt = `# Role
You are a ZigBee Network Log Parser. Your job is to extract network topology data from raw serial logs and output strictly valid JSON.

# Input Data Dictionary (CRITICAL RULES)
Read the logs line by line and apply these rules:

1. **Identify Device Type & ID**:
   - If line contains `ROU NWK: <ID>`, then Node `<ID>` is a **Router** (Type: ROU).
   - If line contains `END NWK: <ID>`, then Node `<ID>` is a **EndDevice** (Type: END).
   - If line contains `Coordinator` or `0000`, treat `0000` as the Root Coordinator (Type: COORD).

2. **Identify Relationships (Edges)**:
   - Look for the pattern `pNWK: <ParentID>`.
   - This means `<ParentID>` is the PARENT of the current node.
   - Direction: From `<ParentID>` TO `<CurrentID>`.

3. **Ignore Noise**:
   - Ignore timestamps (e.g., `[12:00:05]`), "Hello World", or unrelated hex dumps.
   - Only process lines containing `NWK:` and `pNWK:`.

# Output Format
Return ONLY a JSON object with this structure (no markdown, no explanations):
{
  "nodes": [
    { "id": "HexID", "label": "Type\nHexID", "type": "ROU/END/COORD" }
  ],
  "edges": [
    { "from": "ParentID", "to": "ChildID" }
  ]
}

# Few-Shot Example (Learn from this)
Input:
[12:00] ROU NWK: 1234 pNWK: 0000
[12:01] END NWK: 5678 pNWK: 1234

Output:
{
  "nodes": [
    { "id": "0000", "label": "COORD\n0000", "type": "COORD" },
    { "id": "1234", "label": "ROU\n1234", "type": "ROU" },
    { "id": "5678", "label": "END\n5678", "type": "END" }
  ],
  "edges": [
    { "from": "0000", "to": "1234" },
    { "from": "1234", "to": "5678" }
  ]
}

# Your Task
Process the following user logs and generate the JSON:`;

        try {
            // ä¿®æ”¹ï¼šè¯·æ±‚æŒ‡å‘æœ¬åœ° Vercel åç«¯
            const response = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    // åç«¯ç°åœ¨æ”¯æŒç›´æ¥æ¥æ”¶ messages
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: input }
                    ]
                })
            });

            if (!response.ok) {
                const errText = await response.text();
                let errMsg = `HTTP ${response.status}`;
                try {
                    const errJson = JSON.parse(errText);
                    errMsg = errJson.message || errMsg;
                } catch(e) {}
                throw new Error(errMsg);
            }

            const data = await response.json();
            const content = data.choices[0].message.content;
            const jsonStr = content.replace(/```json/g, '').replace(/```/g, '').trim();
            const topologyData = JSON.parse(jsonStr);
            renderGraph(topologyData);
            status.innerText = "è§£ææˆåŠŸ";
        } catch (error) {
            console.error("Analyze Error:", error);
            let msg = error.message;
            if (msg.includes("SyntaxError")) msg = "AI è¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•";
            alert("é”™è¯¯: " + msg + "\n(è¯·ç¡®ä¿å·²åœ¨ Vercel è®¾ç½® AI_API_KEY ç¯å¢ƒå˜é‡)");
            status.innerText = "å‘ç”Ÿé”™è¯¯";
        } finally {
            btn.disabled = false;
            btn.innerHTML = "<span>âœ¨ æ™ºèƒ½ç”Ÿæˆæ‹“æ‰‘å›¾</span>";
            loader.classList.add('hidden');
        }
    }

    function renderGraph(data) {
        if (!nodesDataSet || !edgesDataSet) return;
        nodesDataSet.clear();
        edgesDataSet.clear();

        const nodes = (data.nodes || []).map(node => {
            let color = "#97C2FC";
            let shape = "box";
            const typeLower = (node.type || "").toLowerCase();
            if (node.id === "0000" || typeLower.includes("coord")) { color = "#FF5722"; shape = "hexagon"; }
            else if (typeLower.includes("rou")) { color = "#4CAF50"; shape = "ellipse"; }
            else if (typeLower.includes("end")) { color = "#2196F3"; shape = "box"; }
            return {
                id: node.id,
                label: node.label || `${node.type}\n${node.id}`,
                color: { background: color, border: "white" },
                shape: shape,
                font: { color: "white", face: "arial" },
                shadow: true,
                margin: 10
            };
        });

        const edges = (data.edges || []).map(edge => ({
            from: edge.from,
            to: edge.to,
            arrows: "to",
            color: { color: "#848484" },
            width: 2,
            smooth: { type: "cubicBezier" }
        }));

        nodesDataSet.add(nodes);
        edgesDataSet.add(edges);

        if (!network) {
            const container = document.getElementById("network-container");
            const options = {
                layout: { hierarchical: { direction: "UD", sortMethod: "directed", levelSeparation: 150, nodeSpacing: 200 } },
                physics: { enabled: false },
                interaction: { navigationButtons: true, keyboard: true, zoomView: true }
            };
            network = new vis.Network(container, { nodes: nodesDataSet, edges: edgesDataSet }, options);
        } else {
            network.fit();
        }
    }

    window.onload = function() {
        const exampleText = `[12:00:05] Get Data
ROU NWK: 6702 pNWK: 0000
[12:00:06] Get Data
END NWK: AB49 pNWK: 6702
[12:00:07] Hello World
ROU NWK: 5995 pNWK: 6702
END NWK: A98B pNWK: 5995`;
        document.getElementById('serial-input').value = exampleText;
    }
</script>
</body>
</html>

