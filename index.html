<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZigBee æ‹“æ‰‘æ™ºèƒ½åˆ†æå™¨</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/vis-network.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.1/jsrsasign-all-min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f3f4f6;
            --border-color: #e5e7eb;
            --text-main: #1f2937;
            --text-sub: #6b7280;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        header { background-color: var(--primary-color); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10; }
        header h1 { margin: 0; font-size: 1.25rem; }
        .badge { background-color: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 10px; border: 1px solid rgba(255,255,255,0.3); }
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 350px; min-width: 300px; background: white; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 5; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .panel-header, .panel-footer { padding: 1rem; background-color: #f9fafb; border-bottom: 1px solid var(--border-color); }
        .panel-footer { border-top: 1px solid var(--border-color); border-bottom: none; }
        .panel-body { flex: 1; padding: 1rem; overflow: hidden; }
        textarea { width: 100%; height: 100%; box-sizing: border-box; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.875rem; resize: none; outline: none; }
        textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(37,99,235,0.2); }
        .canvas-area { flex: 1; position: relative; background-color: #f8fafc; }
        #network-container { width: 100%; height: 100%; }
        button { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        button:hover { background-color: var(--primary-hover); }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .input-group { margin-bottom: 0.75rem; position: relative; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--text-sub); font-weight: 600; margin-bottom: 4px; }
        .input-group input { width: 100%; box-sizing: border-box; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.8rem; background-color: white; color: var(--text-main); }
        .input-group input:disabled { background-color: #f3f4f6; color: #6b7280; }
        .legend { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.95); padding: 0.75rem; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color); font-size: 0.75rem; backdrop-filter: blur(4px); }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .legend-item:last-child { margin-bottom: 0; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(2px); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toggle-link { position: absolute; right: 0; top: 0; font-size: 0.75rem; color: var(--primary-color); cursor: pointer; text-decoration: underline; }
        .hidden { display: none !important; }
        #error-banner { background-color: #fee2e2; border-bottom: 1px solid #ef4444; color: #b91c1c; padding: 0.5rem; font-size: 0.875rem; text-align: center; display: none; }
    </style>
</head>
<body>
<div class="app-container">
    <div id="error-banner">âš ï¸ æ ¸å¿ƒåº“åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æµè§ˆå™¨çš„é˜²è·Ÿè¸ªè®¾ç½®ã€‚</div>
    <header>
        <div style="display:flex; align-items:center;">
            <span style="font-size: 1.5rem; margin-right: 8px;">ğŸ•¸ï¸</span>
            <div><h1>ZigBee æ‹“æ‰‘æ™ºèƒ½åˆ†æå™¨</h1></div>
            <span class="badge">GLM-4.5 Flash</span>
        </div>
        <div style="font-size: 0.875rem; opacity: 0.9;">çŠ¶æ€: <span id="status-text">å‡†å¤‡å°±ç»ª</span></div>
    </header>
    <div class="main-content">
        <aside class="sidebar">
            <div class="panel-header">
                <label style="font-weight: bold; font-size: 0.875rem; display: block; margin-bottom: 4px;">ğŸ“ ä¸²å£åŸå§‹æ•°æ®</label>
                <div style="font-size: 0.75rem; color: var(--text-sub);">ç›´æ¥ç²˜è´´ä¸²å£è¾“å‡ºï¼ŒAI å°†è‡ªåŠ¨åˆ†æ</div>
            </div>
            <div class="panel-body">
                <textarea id="serial-input" placeholder="ç²˜è´´ä¸²å£è¾“å‡ºæ•°æ®..."></textarea>
            </div>
            <div class="panel-footer">
                <div class="input-group">
                    <label>API Key</label>
                    <span class="toggle-link" onclick="toggleKeyVisibility()">ä¿®æ”¹</span>
                    <input type="password" id="api-key" value="" disabled>
                </div>
                <button onclick="analyzeTopology()" id="generate-btn">âœ¨ æ™ºèƒ½ç”Ÿæˆæ‹“æ‰‘å›¾</button>
            </div>
        </aside>
        <main class="canvas-area">
            <div id="network-container"></div>
            <div class="legend">
                <div style="font-weight: bold; margin-bottom: 6px; color: var(--text-main);">å›¾ä¾‹</div>
                <div class="legend-item"><span class="dot" style="background:#FF5722;"></span> åè°ƒå™¨</div>
                <div class="legend-item"><span class="dot" style="background:#4CAF50;"></span> è·¯ç”±å™¨</div>
                <div class="legend-item"><span class="dot" style="background:#2196F3;"></span> ç»ˆç«¯è®¾å¤‡</div>
            </div>
            <div id="loading-indicator" class="loading hidden">
                <div class="spinner"></div>
                <div style="color: var(--primary-color); font-weight: 600;">GLM-4.5 æ­£åœ¨åˆ†æç½‘ç»œç»“æ„...</div>
                <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">è¯·ç¨å€™...</div>
            </div>
        </main>
    </div>
</div>
<script>
    let network = null;
    let nodesDataSet = null;
    let edgesDataSet = null;

    window.addEventListener('load', function() {
        if (typeof vis === 'undefined') {
            document.getElementById('error-banner').style.display = 'block';
            console.error("Vis.js åº“åŠ è½½å¤±è´¥");
        } else {
            nodesDataSet = new vis.DataSet();
            edgesDataSet = new vis.DataSet();
        }
    });

    function generateToken(apiKey) {
        try {
            if (typeof KJUR === 'undefined') throw new Error("åŠ å¯†åº“æœªåŠ è½½");
            const parts = apiKey.split(".");
            if (parts.length !== 2) throw new Error("API Key æ ¼å¼é”™è¯¯");
            const id = parts[0];
            const secret = parts[1];
            const now = Date.now();
            const header = { alg: "HS256", sign_type: "SIGN" };
            const payload = { api_key: id, exp: now + 3600 * 1000, timestamp: now };
            return KJUR.jws.JWS.sign("HS256", JSON.stringify(header), JSON.stringify(payload), secret);
        } catch (e) {
            console.error("Token Error:", e);
            alert("Token ç”Ÿæˆå¤±è´¥: " + e.message);
            return null;
        }
    }

    async function analyzeTopology() {
        const input = document.getElementById('serial-input').value.trim();
        const apiKey = document.getElementById('api-key').value.trim();
        const btn = document.getElementById('generate-btn');
        const loader = document.getElementById('loading-indicator');
        const status = document.getElementById('status-text');

        if (!input) { alert("è¯·å…ˆç²˜è´´ä¸²å£æ•°æ®ï¼"); return; }
        if (!apiKey) { alert("è¯·å…ˆè¾“å…¥ API Keyï¼"); return; }
        if (typeof vis === 'undefined') { alert("å›¾å½¢åº“åŠ è½½å¤±è´¥"); return; }

        const token = generateToken(apiKey);
        if (!token) return;

        btn.disabled = true;
        btn.innerHTML = "åˆ†æä¸­...";
        loader.classList.remove('hidden');
        status.innerText = "AI è§£æä¸­...";

        const systemPrompt = `ä½ æ˜¯ä¸€ä¸ª ZigBee ç½‘ç»œæ—¥å¿—åˆ†æä¸“å®¶ã€‚
ä»ä¸²å£è¾“å‡ºä¸­æå–ç½‘ç»œæ‹“æ‰‘ï¼š
- è®¾å¤‡ç±»å‹ (ROU, END, COORDINATOR)
- æœ¬èŠ‚ç‚¹åœ°å€ (NWK)
- çˆ¶èŠ‚ç‚¹åœ°å€ (pNWK)

è¾“å‡ºçº¯ JSONï¼ˆæ—  Markdownï¼‰ï¼š
{"nodes": [{"id": "0000", "label": "Coordinator\\n0000", "type": "Coordinator"}], "edges": [{"from": "0000", "to": "ABCD"}]}`;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        try {
            const response = await fetch("https://open.bigmodel.cn/api/paas/v4/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    model: "glm-4.5-flash",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: input }
                    ],
                    temperature: 0.1,
                    top_p: 0.7
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const content = data.choices[0].message.content;
            const jsonStr = content.replace(/```json/g, '').replace(/```/g, '').trim();
            const topologyData = JSON.parse(jsonStr);
            renderGraph(topologyData);
            status.innerText = "è§£ææˆåŠŸ";
        } catch (error) {
            console.error("Analyze Error:", error);
            let msg = error.message;
            if (error.name === 'AbortError') msg = "è¯·æ±‚è¶…æ—¶ (30s)";
            else if (msg.includes("Failed to fetch")) msg = "ç½‘ç»œè¯·æ±‚è¢«æ‹¦æˆª";
            alert("ç”Ÿæˆå¤±è´¥: " + msg);
            status.innerText = "å‘ç”Ÿé”™è¯¯";
        } finally {
            btn.disabled = false;
            btn.innerHTML = "<span>âœ¨ æ™ºèƒ½ç”Ÿæˆæ‹“æ‰‘å›¾</span>";
            loader.classList.add('hidden');
        }
    }

    function renderGraph(data) {
        if (!nodesDataSet || !edgesDataSet) return;
        nodesDataSet.clear();
        edgesDataSet.clear();

        const nodes = (data.nodes || []).map(node => {
            let color = "#97C2FC";
            let shape = "box";
            const typeLower = (node.type || "").toLowerCase();
            if (node.id === "0000" || typeLower.includes("coord")) { color = "#FF5722"; shape = "hexagon"; }
            else if (typeLower.includes("rou")) { color = "#4CAF50"; shape = "ellipse"; }
            else if (typeLower.includes("end")) { color = "#2196F3"; shape = "box"; }
            return {
                id: node.id,
                label: node.label || `${node.type}\n${node.id}`,
                color: { background: color, border: "white" },
                shape: shape,
                font: { color: "white", face: "arial" },
                shadow: true,
                margin: 10
            };
        });

        const edges = (data.edges || []).map(edge => ({
            from: edge.from,
            to: edge.to,
            arrows: "to",
            color: { color: "#848484" },
            width: 2,
            smooth: { type: "cubicBezier" }
        }));

        nodesDataSet.add(nodes);
        edgesDataSet.add(edges);

        if (!network) {
            const container = document.getElementById("network-container");
            const options = {
                layout: { hierarchical: { direction: "UD", sortMethod: "directed", levelSeparation: 150, nodeSpacing: 200 } },
                physics: { enabled: false },
                interaction: { navigationButtons: true, keyboard: true, zoomView: true }
            };
            network = new vis.Network(container, { nodes: nodesDataSet, edges: edgesDataSet }, options);
        } else {
            network.fit();
        }
    }

    function toggleKeyVisibility() {
        const input = document.getElementById('api-key');
        input.disabled = !input.disabled;
        input.type = input.disabled ? "password" : "text";
        if (!input.disabled) input.focus();
    }

    window.onload = function() {
        const exampleText = `[12:00:05] Get Data
ROU NWK: 6702 pNWK: 0000
[12:00:06] Get Data
END NWK: AB49 pNWK: 6702
[12:00:07] Hello World
ROU NWK: 5995 pNWK: 6702
END NWK: A98B pNWK: 5995`;
        document.getElementById('serial-input').value = exampleText;
    }
</script>
</body>
</html>
